<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Saving Dollars with Diversion</title>
  <!-- D3 for CSV loading -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
  <style>
    :root {
      /* light theme */
      --bg-color:       #fff;
      --text-color:     #333;
      --cardinal:       #8C1515;
      --cardinal-hover: #A31F1F;
      --btn-text:       #fff;
      --chart-paper:    #fafafa;
      --chart-plot:     #fff;
      --grid-color:     #ddd;
      --zeroline-color: #bbb;
    }
    .dark {
      /* dark theme overrides */
      --bg-color:       #222;
      --text-color:     #eee;
      --cardinal:       #C34A4A;
      --cardinal-hover: #E06666;
      --btn-text:       #222;
      --chart-paper:    #333;
      --chart-plot:     #222;
      --grid-color:     #555;
      --zeroline-color: #777;
    }
    body {
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      margin: 0 auto; padding: 10px;
      box-sizing: border-box;
      max-width: 100%;
      position: relative;
    }
    /* Storyline title */
    h1.storyline {
      text-align: center;
      font-size: 36px;
      margin-bottom: 8px;
      font-weight: bold;
    }
    /* Dark mode switch */
    .toggle-container {
      position: absolute;
      top: 20px; right: 20px;
      display: flex; align-items: center;
      cursor: pointer; user-select: none;
      font-size: 14px;
    }
    .toggle-container input {
      opacity: 0; width: 0; height: 0;
    }
    .switch {
      position: relative; width: 40px; height: 20px; margin-left: 8px;
    }
    .slider {
      position: absolute; top:0; left:0; right:0; bottom:0;
      background-color: #ccc; transition: .4s; border-radius: 20px;
    }
    .slider:before {
      position: absolute; content: "";
      height:16px; width:16px; left:2px; bottom:2px;
      background-color:white; transition:.4s; border-radius:50%;
    }
    .toggle-container input:checked + .switch .slider {
      background-color: var(--cardinal);
    }
    .toggle-container input:checked + .switch .slider:before {
      transform: translateX(20px);
    }

    h2 {
      margin: 24px 0 8px;
      font-size: 24px; font-weight: bold;
      display: flex; align-items: center;
    }
    #controls {
      text-align: right; margin: 8px 0 16px;
    }
    button {
      background: var(--cardinal);
      color: var(--btn-text);
      border: none; border-radius: 4px;
      padding: 8px 16px; font-size: 14px;
      cursor: pointer; margin-left: 8px;
    }
    button:hover {
      background: var(--cardinal-hover);
    }
    .chart-container { width: 100%; margin-bottom: 48px; }
    .tip {
      font-size: 13px; color: var(--text-color);
      margin-top: 4px; font-style: italic;
    }
    .download-btn {
      background: var(--cardinal);
      color: var(--btn-text);
      border: none; border-radius: 4px;
      padding: 6px 12px; font-size: 14px;
      cursor: pointer; margin-top: 8px;
    }
    .download-btn:hover {
      background: var(--cardinal-hover);
    }
    .info-icon { margin-left: 8px; cursor: help; }

    @media (max-width: 600px) {
      h1.storyline { font-size: 28px; }
      h2 {
        font-size: 20px;
        margin: 16px 0 6px;
      }
      button, .download-btn {
        padding: 6px 10px;
        font-size: 12px;
      }
      .tip {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>

  <h1 class="storyline">Saving Dollars with Diversion</h1>

  <label class="toggle-container">
    Dark Mode
    <input type="checkbox" id="darkToggleSwitch">
    <div class="switch"><span class="slider"></span></div>
  </label>

  <div class="chart-container">
    <h2>
      Monthly Savings from Diversion
      <span class="info-icon"
            title="• Drag the date slider underneath to zoom
• Click & drag inside the plot to pan/zoom
• Click legend entries to show/hide traces
• Use the ‘Show Cumulative’ button to switch views">
        ℹ️
      </span>
    </h2>
    <div id="controls">
      <button id="toggleView">Show Cumulative</button>
    </div>
    <div id="savingsPlot"></div>
    <button id="downloadSavings" class="download-btn">Download Savings Data</button>
    <p class="tip">Tip: Drag the slider below or click legend items to explore the data.</p>
  </div>

  <div class="chart-container">
    <h2>
      Cost Breakdown vs. Hypothetical All‑Landfill
      <span class="info-icon"
            title="• Use the date slider to zoom
• Click legend entries to toggle streams">
        ℹ️
      </span>
    </h2>
    <div id="costPlot"></div>
    <button id="downloadCost" class="download-btn">Download Cost Data</button>
    <p class="tip">Tip: Click on any legend entry (e.g. Landfill, Compost) to toggle that stream.</p>
  </div>

  <script>
    let savingsLayout, costLayout;
    let savingsPlotInited = false, costPlotInited = false;

    d3.csv('data/monthly_savings.csv').then(rows => {
      const dates      = rows.map(r => r.Date);
      const monthly    = rows.map(r => +r.monthly_savings);
      const cumulative = rows.map(r => +r.cumulative_savings);
      const actualCost = rows.map(r => +r.actual_cost);
      const hypoCost   = rows.map(r => +r.hypothetical_cost);

      // --- Savings Chart ---
      let mode = 'monthly';
      const traceM = { x: dates, y: monthly, mode: 'lines+markers',
        name: 'Monthly Savings', line: { color: '#17becf', width: 2 },
        hovertemplate: '%{x}<br>$%{y:.2f}<extra></extra>' };
      const traceC = { x: dates, y: cumulative, mode: 'lines+markers',
        name: 'Cumulative Savings', line: { color: '#7f7f7f', width: 2 },
        visible: false, hovertemplate: '%{x}<br>$%{y:.2f}<extra></extra>' };
      savingsLayout = {
        font: { family: 'Helvetica Neue, Arial, sans-serif', size: 14, color: 'var(--text-color)' },
        paper_bgcolor: 'var(--chart-paper)',
        plot_bgcolor: 'var(--chart-plot)',
        margin: { t:20, r:30, b:80, l:60 },
        xaxis: {
          title: { text: 'Date', font: { size:16, color:'var(--text-color)' } },
          tickfont: { size:12, color:'var(--text-color)' },
          gridcolor: 'var(--grid-color)',
          zerolinecolor: 'var(--zeroline-color)',
          rangeselector: {
            bgcolor: 'var(--cardinal)',
            activecolor: 'var(--cardinal-hover)',
            font: { color: '#fff' },
            buttons: [
              {count:6,label:'6m',step:'month',stepmode:'backward'},
              {count:1,label:'1y',step:'year',stepmode:'backward'},
              {step:'all',label:'All'}
            ]
          },
          rangeslider: { visible:true, bgcolor:'var(--chart-plot)' },
          type: 'date'
        },
        yaxis: {
          title: { text: 'Savings ($)', font: { size:16, color:'var(--text-color)' } },
          tickfont: { size:12, color:'var(--text-color)' },
          gridcolor: 'var(--grid-color)',
          zerolinecolor: 'var(--zeroline-color)'
        },
        hovermode: 'closest',
        shapes: [
          { type:'line', x0:'2020-05-01', x1:'2020-05-01', y0:0, y1:Math.max(...monthly)*1.1,
            line:{ color:'#d62728', dash:'dot' } },
          { type:'line', x0:'2022-08-01', x1:'2022-08-01', y0:0, y1:Math.max(...monthly)*1.1,
            line:{ color:'#2ca02c', dash:'dot' } }
        ],
        annotations: [
          { x:'2020-05-01', y:Math.max(...monthly)*1.05, xref:'x', yref:'y',
            text:'Move‑Out Campaign', showarrow:true, arrowhead:2, ax:0, ay:-40,
            font:{ color:'#d62728', size:12 } },
          { x:'2022-08-01', y:Math.max(...monthly)*1.05, xref:'x', yref:'y',
            text:'Dining Hall Compost Pilot', showarrow:true, arrowhead:2, ax:0, ay:-40,
            font:{ color:'#2ca02c', size:12 } }
        ]
      };
      Plotly.newPlot('savingsPlot', [traceM, traceC], savingsLayout, {responsive:true})
        .then(() => savingsPlotInited = true);
      document.getElementById('toggleView').onclick = function(){
        if(mode==='monthly'){
          Plotly.restyle('savingsPlot',{visible:[false,true]});
          this.textContent='Show Monthly'; mode='cumulative';
        } else {
          Plotly.restyle('savingsPlot',{visible:[true,false]});
          this.textContent='Show Cumulative'; mode='monthly';
        }
      };

      // --- Cost Breakdown Chart ---
      const fractions = [0.4,0.3,0.2,0.1],
            streams   = ['Landfill','Recycling','Compost','Reuse'],
            colors    = ['#555555','#1f77b4','#2ca02c','#ff7f0e'];
      const costTraces = streams.map((name,i) => ({
        x: dates, y: actualCost.map(c=>c*fractions[i]),
        name, stackgroup:'one', fillcolor:colors[i]
      }));
      costTraces.push({
        x: dates, y: hypoCost,
        name: 'All‑Landfill Cost', mode: 'lines',
        line: { dash:'dash', color:'#d62728', width:2 }
      });
      costLayout = {
        font: { family:'Helvetica Neue, Arial, sans-serif', size:14, color:'var(--text-color)' },
        paper_bgcolor: 'var(--chart-paper)',
        plot_bgcolor: 'var(--chart-plot)',
        margin: { t:20, r:30, b:80, l:60 },
        xaxis: {
          title: { text:'Date', font:{ size:16, color:'var(--text-color)' } },
          tickfont: { size:12, color:'var(--text-color)' },
          gridcolor: 'var(--grid-color)', zerolinecolor:'var(--zeroline-color)',
          rangeslider:{ visible:true, bgcolor:'var(--chart-plot)' },
          type:'date'
        },
        yaxis: {
          title: { text:'Cost ($)', font:{ size:16, color:'var(--text-color)' } },
          tickfont: { size:12, color:'var(--text-color)' },
          gridcolor: 'var(--grid-color)', zerolinecolor:'var(--zeroline-color)'
        },
        hovermode:'closest',
        shapes: [
          { type:'line', x0:'2020-05-01', x1:'2020-05-01', y0:0, y1:Math.max(...actualCost)*1.1,
            line:{ color:'#d62728', dash:'dot' } },
          { type:'line', x0:'2022-08-01', x1:'2022-08-01', y0:0, y1:Math.max(...actualCost)*1.1,
            line:{ color:'#2ca02c', dash:'dot' } }
        ],
        annotations: [
          { x:'2020-05-01', y:Math.max(...actualCost)*1.05, xref:'x', yref:'y',
            text:'Move‑Out Campaign', showarrow:true, arrowhead:2, ax:0, ay:-40,
            font:{ color:'#d62728', size:12 } },
          { x:'2022-08-01', y:Math.max(...actualCost)*1.05, xref:'x', yref:'y',
            text:'Dining Hall Compost Pilot', showarrow:true, arrowhead:2, ax:0, ay:-40,
            font:{ color:'#2ca02c', size:12 } }
        ]
      };
      Plotly.newPlot('costPlot', costTraces, costLayout, {responsive:true})
        .then(() => costPlotInited = true);

      // --- Download Data ---
      function rowsToCSV(arr, cols) {
        const header = cols.join(','),
              lines  = arr.map(r => cols.map(c => `"${r[c]}"`).join(','));
        return [header, ...lines].join('\n');
      }
      function downloadCSV(content, filename) {
        const blob = new Blob([content], { type:'text/csv' }),
              url  = URL.createObjectURL(blob),
              a    = document.createElement('a');
        a.href = url; a.download = filename; a.click();
        URL.revokeObjectURL(url);
      }
      document.getElementById('downloadSavings').onclick = () => {
        downloadCSV(rowsToCSV(rows, ['Date','monthly_savings','cumulative_savings']), 'savings_data.csv');
      };
      document.getElementById('downloadCost').onclick = () => {
        downloadCSV(rowsToCSV(rows.map(r => ({
          Date: r.Date,
          actual_cost: r.actual_cost,
          hypothetical_cost: r.hypothetical_cost
        })), ['Date','actual_cost','hypothetical_cost']), 'cost_data.csv');
      };

      // --- Dark Mode Toggle ---
      document.getElementById('darkToggleSwitch').addEventListener('change', e => {
        document.body.classList.toggle('dark', e.target.checked);
        const relayout = {
          paper_bgcolor:  getComputedStyle(document.documentElement).getPropertyValue('--chart-paper'),
          plot_bgcolor:   getComputedStyle(document.documentElement).getPropertyValue('--chart-plot'),
          'font.color':   getComputedStyle(document.documentElement).getPropertyValue('--text-color'),
          'xaxis.gridcolor':     getComputedStyle(document.documentElement).getPropertyValue('--grid-color'),
          'xaxis.zerolinecolor': getComputedStyle(document.documentElement).getPropertyValue('--zeroline-color'),
          'yaxis.gridcolor':     getComputedStyle(document.documentElement).getPropertyValue('--grid-color'),
          'yaxis.zerolinecolor': getComputedStyle(document.documentElement).getPropertyValue('--zeroline-color')
        };
        if (savingsPlotInited) Plotly.relayout('savingsPlot', relayout);
        if (costPlotInited)    Plotly.relayout('costPlot',    relayout);
      });
    }).catch(console.error);
  </script>
</body>
</html>